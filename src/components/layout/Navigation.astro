---
import { getLocale, t } from "../../i18n/index";

const locale = getLocale(Astro.currentLocale);

interface NavItem {
	id: string;
	label: string;
}

const navItems: NavItem[] = [
	{ id: "about", label: t(locale, "nav.about") },
	{ id: "experience", label: t(locale, "nav.experience") },
	{ id: "projects", label: t(locale, "nav.projects") },
	{ id: "certifications", label: t(locale, "nav.certifications") },
];
---

<nav class="navigation" aria-label={t(locale, "aria.mainNav")}>
  <ul class="nav-list">
    {navItems.map((item) => (
      <li>
        <a href={`#${item.id}`} class="nav-link" data-section={item.id}>
          <span class="nav-indicator" />
          <span class="nav-text">{item.label}</span>
        </a>
      </li>
    ))}
  </ul>
</nav>

<script>
  let navController: AbortController | null = null;

  function initNavigation() {
    navController?.abort();
    navController = new AbortController();
    const { signal } = navController;

    const navLinks = document.querySelectorAll<HTMLAnchorElement>('.nav-link');
    const sections = document.querySelectorAll<HTMLElement>('section[id]');

    if (navLinks.length === 0 || sections.length === 0) return;

    const sectionsArray = Array.from(sections);
    let currentActive: string | null = null;
    let clickLockUntil = 0;

    function setActiveLink(sectionId: string, fromClick = false) {
      if (currentActive === sectionId) return;
      currentActive = sectionId;
      navLinks.forEach(link => {
        const isActive = link.dataset.section === sectionId;
        link.classList.toggle('active', isActive);
        if (isActive) {
          link.setAttribute('aria-current', 'true');
        } else {
          link.removeAttribute('aria-current');
        }
      });
      if (fromClick) {
        clickLockUntil = Date.now() + 800;
      }
    }

    function updateActiveSection() {
      if (Date.now() < clickLockUntil) return;

      const scrollY = window.scrollY;
      const viewportHeight = window.innerHeight;
      const documentHeight = document.documentElement.scrollHeight;

      // Near the top of the page - activate first section
      if (scrollY < viewportHeight * 0.25) {
        setActiveLink(sectionsArray[0].id);
        return;
      }

      // Near the bottom of the page - activate last section
      if (scrollY + viewportHeight >= documentHeight - 100) {
        setActiveLink(sectionsArray[sectionsArray.length - 1].id);
        return;
      }

      // Find section whose top is closest to viewport top (with offset)
      const targetLine = viewportHeight * 0.2;
      let bestSection: string | null = null;
      let bestScore = -Infinity;

      sectionsArray.forEach(section => {
        const rect = section.getBoundingClientRect();
        // Skip if section is not visible
        if (rect.bottom < 0 || rect.top > viewportHeight) return;

        // Score based on how much of the section is in the upper portion of viewport
        // Prefer sections whose top is at or above the target line
        let score = 0;
        if (rect.top <= targetLine) {
          score = 1000 - Math.abs(rect.top);
        } else {
          score = -rect.top;
        }

        if (score > bestScore) {
          bestScore = score;
          bestSection = section.id;
        }
      });

      if (bestSection) {
        setActiveLink(bestSection);
      }
    }

    // Throttled scroll handler
    let ticking = false;
    function onScroll() {
      if (!ticking) {
        window.requestAnimationFrame(() => {
          updateActiveSection();
          ticking = false;
        });
        ticking = true;
      }
    }

    window.addEventListener('scroll', onScroll, { passive: true, signal });

    // Handle nav link clicks - lock active state briefly
    navLinks.forEach(link => {
      link.addEventListener('click', () => {
        const sectionId = link.dataset.section;
        if (sectionId) {
          setActiveLink(sectionId, true);
        }
      }, { signal });
    });

    // Set initial active state
    const hash = window.location.hash.slice(1);
    if (hash && document.getElementById(hash)) {
      setActiveLink(hash, true);
    } else {
      updateActiveSection();
    }
  }

  // Run on initial load and after view transitions
  document.addEventListener('astro:page-load', initNavigation);
  initNavigation();
</script>

<style>
  .navigation {
    display: none;
  }

  @media (min-width: 1024px) {
    .navigation {
      display: block;
    }
  }

  .nav-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .nav-link {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.25rem 0;
    color: var(--secondary-text);
    font-size: 0.75rem;
    font-weight: 600;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    transition: color 0.2s ease-in-out;
  }

  .nav-link:hover {
    color: var(--primary-text);
  }

  .nav-link:hover .nav-indicator {
    transform: scaleX(1);
    background-color: var(--primary-text);
  }

  .nav-link.active {
    color: var(--accent);
  }

  .nav-link.active .nav-indicator {
    transform: scaleX(1);
    background-color: var(--accent);
  }

  .nav-indicator {
    width: 4rem;
    height: 1px;
    background-color: var(--tertiary-text);
    transform: scaleX(0.5);
    transform-origin: left center;
    transition: transform 0.2s ease-in-out, background-color 0.2s ease-in-out;
  }

  .nav-text {
    transition: transform 0.2s ease-in-out;
  }

  .nav-link:hover .nav-text {
    transform: translateX(4px);
  }

  .nav-link.active .nav-text {
    transform: translateX(4px);
  }
</style>
