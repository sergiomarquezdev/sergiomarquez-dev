---
import BaseHead from "../components/BaseHead.astro";
import LanguageSwitcher from "../components/LanguageSwitcher.astro";
import MainContent from "../components/layout/MainContent.astro";
import SidebarLeft from "../components/layout/SidebarLeft.astro";
import SidebarRight from "../components/layout/SidebarRight.astro";
import Spotlight from "../components/Spotlight.astro";
import { getCv } from "../data/cv";
import { getLocale, t } from "../i18n/index";
import "../styles/global.css";

interface Props {
	title: string;
	description: string;
}

const { title, description } = Astro.props;
const locale = getLocale(Astro.currentLocale);
const { basics } = getCv(locale);
const homeHref = locale === "en" ? "/en/" : "/";
---

<!doctype html>
<html lang={locale} style="color-scheme: dark">
  <head>
    <BaseHead title={title} description={description} />
    <link rel="manifest" href="/manifest.webmanifest" />
    <!-- Language detection: redirect English speakers on first visit -->
    <script is:inline>
      (function() {
        try {
          var KEY = 'preferred-locale';
          if (localStorage.getItem(KEY)) return;
          var path = window.location.pathname;
          var isEn = path.startsWith('/en');
          var lang = navigator.language || '';
          if (lang.startsWith('en') && !isEn) {
            localStorage.setItem(KEY, 'en');
            window.location.replace('/en/');
          } else {
            localStorage.setItem(KEY, isEn ? 'en' : 'es');
          }
        } catch (e) { /* Private browsing or storage unavailable */ }
      })();
    </script>
  </head>
  <body>
    <a href="#main" class="skip-link">{t(locale, "skip.main")}</a>
    <Spotlight />

    <!-- Mobile Header (visible < 1024px) -->
    <header class="mobile-header">
      <div class="mobile-header-content">
        <div class="mobile-header-top">
          <h1 class="mobile-name">
            <a href={homeHref}>{basics.name}</a>
          </h1>
          <LanguageSwitcher />
        </div>
        <p class="mobile-tagline">{basics.tagline}</p>
      </div>
    </header>

    <div class="layout-container">
      <div class="layout-wrapper">
        <SidebarLeft basics={basics} />
        <MainContent>
          <slot />
        </MainContent>
      </div>
    </div>

    <SidebarRight email={basics.email} />

    <style>
      .skip-link {
        position: absolute;
        top: -40px;
        left: 0;
        padding: 0.5rem 1rem;
        background: var(--accent);
        color: var(--background);
        font-weight: 600;
        z-index: 100;
        transition: top 0.2s ease-in-out;
      }

      .skip-link:focus {
        top: 0;
      }

      .layout-container {
        width: 100%;
        min-height: 100vh;
      }

      .layout-wrapper {
        display: block;
        max-width: 1280px;
        margin: 0 auto;
        padding: 0 1.5rem;
      }

      @media (min-width: 1024px) {
        .layout-wrapper {
          display: flex;
          gap: 1rem;
          padding: 0 3rem;
        }
      }

      @media (min-width: 1280px) {
        .layout-wrapper {
          padding: 0 4rem;
        }
      }

      @media (min-width: 1536px) {
        .layout-wrapper {
          padding: 0 6rem;
        }
      }

      .mobile-header {
        display: block;
        padding: 1.5rem;
        border-bottom: 1px solid var(--border-color);
      }

      @media (min-width: 1024px) {
        .mobile-header {
          display: none;
        }
      }

      .mobile-header-content {
        max-width: 768px;
        margin: 0 auto;
      }

      .mobile-header-top {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
      }

      .mobile-name {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 700;
        letter-spacing: -0.02em;
      }

      .mobile-name a {
        color: var(--primary-text);
      }

      .mobile-name a:hover {
        color: var(--accent);
      }

      .mobile-tagline {
        margin: 0.25rem 0 0 0;
        font-size: 0.9rem;
        color: var(--secondary-text);
      }
    </style>
  </body>
</html>
