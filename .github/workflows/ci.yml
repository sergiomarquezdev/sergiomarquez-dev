name: ğŸš€ CI/CD - Build, Test & Deploy

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - '.editorconfig'
      - '.gitignore'
      - 'docs/**'
  pull_request:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - '.editorconfig'
      - '.gitignore'
      - 'docs/**'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  # ğŸ§ª Testing & Quality Assurance
  test-and-validate:
    name: ğŸ” Quality Assurance
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v5.0.0

      - name: âš™ï¸ Set up Node.js 22.x
        uses: actions/setup-node@v4.4.0
        with:
          node-version: 22.x
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” TypeScript validation
        run: |
          echo "ğŸ” Running TypeScript check..."
          npm run type-check
          echo "âœ… TypeScript validation passed!"

      - name: ğŸ§¹ ESLint code quality
        run: |
          echo "ğŸ§¹ Running ESLint..."
          npm run lint
          echo "âœ… Code quality check completed!"

      - name: ğŸ’„ Prettier formatting check
        run: |
          echo "ğŸ’„ Checking code formatting..."
          npm run format:check
          echo "âœ… Code formatting validated!"

      - name: ğŸ” Security audit
        run: |
          echo "ğŸ” Running security audit..."
          npm audit --audit-level=moderate
          echo "âœ… Security audit completed!"

      - name: ğŸ“¦ Dependency validation
        run: |
          echo "ğŸ“¦ Validating dependencies..."
          npm ls --depth=0
          echo "âœ… Dependencies validated!"

  # ğŸ—ï¸ Build & Deploy
  build-and-deploy:
    name: ğŸ—ï¸ Build & Deploy
    runs-on: ubuntu-latest
    needs: test-and-validate
    timeout-minutes: 20

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v5.0.0

      - name: âš™ï¸ Set up Node.js 22.x
        uses: actions/setup-node@v4.4.0
        with:
          node-version: 22.x
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build Astro portfolio
        run: |
          echo "ğŸ—ï¸ Building Astro portfolio..."
          npm run build
          echo "âœ… Build completed successfully!"

      - name: ğŸ“Š Verify build output & metrics
        run: |
          echo "ğŸ“Š Build metrics:"
          echo "ğŸ“ Build output size:"
          du -sh dist/

          echo ""
          echo "ğŸ“„ Generated files breakdown:"
          HTML_COUNT=$(find dist/ -name "*.html" | wc -l)
          JS_COUNT=$(find dist/ -name "*.js" | wc -l)
          CSS_COUNT=$(find dist/ -name "*.css" | wc -l)

          echo "ğŸ“„ HTML files: $HTML_COUNT"
          echo "ğŸ“œ JS files: $JS_COUNT"
          echo "ğŸ¨ CSS files: $CSS_COUNT"

          echo ""
          echo "ğŸ¯ Portfolio validation:"
          if [ "$HTML_COUNT" -ge 5 ]; then
            echo "âœ… HTML pages: $HTML_COUNT (target: 5+)"
          else
            echo "âš ï¸ HTML pages: $HTML_COUNT (expected: 5+)"
          fi

          echo ""
          echo "ğŸ”— Deployment ready for:"
          echo "   â€¢ Primary: https://sergiomarquez.dev"

      - name: ğŸ§ª Test site preview
        run: |
          echo "ğŸ§ª Testing site preview..."
          timeout 15s npm run preview > preview.log 2>&1 || true
          echo "âœ… Preview test completed"

          # Check if preview started successfully
          if grep -q "Local:" preview.log; then
            echo "âœ… Preview server started successfully"
          else
            echo "â„¹ï¸ Preview test completed (timeout expected)"
          fi

      - name: ğŸ“¦ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 1

  # ğŸŒ Post-Deploy Verification & Health Checks
  post-deploy-verification:
    name: ğŸŒ Site Health Check
    runs-on: ubuntu-latest
    needs: build-and-deploy
    timeout-minutes: 10
    if: github.ref == 'refs/heads/main'

    steps:
      - name: ğŸ¥ Health check - Main site
        run: |
          echo "ğŸ¥ Checking site health..."

          # Check if site is accessible
          if curl -f -s -o /dev/null "https://sergiomarquez.dev"; then
            echo "âœ… Main site is accessible"
          else
            echo "âŒ Main site health check failed"
            exit 1
          fi

      - name: ğŸ” Critical pages verification
        run: |
          echo "ğŸ” Verifying critical pages..."

          # Check homepage
          if curl -f -s "https://sergiomarquez.dev" | grep -q "Sergio"; then
            echo "âœ… Homepage loading correctly"
          else
            echo "âŒ Homepage check failed"
            exit 1
          fi

      - name: ğŸ“Š Performance baseline check
        run: |
          echo "ğŸ“Š Basic performance metrics..."

          # Check page load time
          START_TIME=$(date +%s%N)
          curl -f -s -o /dev/null "https://sergiomarquez.dev"
          END_TIME=$(date +%s%N)
          DURATION=$(( (END_TIME - START_TIME) / 1000000 ))

          echo "â±ï¸ Homepage load time: ${DURATION}ms"

          if [ "$DURATION" -lt 2000 ]; then
            echo "âœ… Load time acceptable (${DURATION}ms < 2000ms)"
          else
            echo "âš ï¸ Load time high: ${DURATION}ms"
          fi

  # ğŸ¤– Auto-Fix Common Issues
  auto-fix-issues:
    name: ğŸ¤– Auto-Fix & Dependencies
    runs-on: ubuntu-latest
    if: failure() && github.ref == 'refs/heads/main'
    needs: [test-and-validate, build-and-deploy]
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v5.0.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: âš™ï¸ Set up Node.js 22.x
        uses: actions/setup-node@v4.4.0
        with:
          node-version: 22.x
          cache: 'npm'

      - name: ğŸ”§ Auto-fix linting issues
        run: |
          echo "ğŸ”§ Attempting to auto-fix linting issues..."
          npm ci
          npm run lint:fix || true
          npm run format || true

          # Check if files were modified
          if git diff --quiet; then
            echo "â„¹ï¸ No auto-fixable issues found"
          else
            echo "ğŸ”§ Auto-fixed some issues, committing..."
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action Auto-Fix"
            git add .
            git commit -m "ğŸ¤– Auto-fix: ESLint and Prettier formatting

            - Applied automatic linting fixes
            - Standardized code formatting
            - Triggered by failed CI pipeline"
            git push
          fi

      - name: ğŸ”„ Update dependencies (if needed)
        run: |
          echo "ğŸ”„ Checking for dependency updates..."

          # Check for security vulnerabilities
          if npm audit --audit-level=moderate; then
            echo "âœ… No critical security issues"
          else
            echo "ğŸ”§ Attempting to fix security issues..."
            npm audit fix --force || true

            if ! git diff --quiet package*.json; then
              echo "ğŸ“¦ Dependencies updated, committing..."
              git add package*.json
              git commit -m "ğŸ”’ Security: Auto-update vulnerable dependencies

              - Fixed security vulnerabilities via npm audit fix
              - Automated dependency security update"
              git push
            fi
          fi
  #
  #   steps:
  #     - name: Download build artifacts
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: dist
  #         path: dist/
  #
  #     - name: Deploy to hosting
  #       run: echo "Deploy step would go here"
